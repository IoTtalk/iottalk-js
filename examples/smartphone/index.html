<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smartphone</title>
    <link rel="stylesheet" type="text/css" href="./css/gsensor.css">
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"></script>
    <script src="/build/dan2-web.js"></script>
</head>
<body>

    <main>
        <h2 id="uuid"></h2>

        <section> <h6>Acceleration</h6>  </section>

        <section id="Ax">
            <label><i>x</i></label>
            <span></span>
        </section>
        <section id="Ay">
            <label><i>y</i></label>
            <span></span>
        </section>
        <section id="Az">
            <label><i>z</i></label>
            <span></span>
        </section>

    </main>


    <script type="text/javascript">

    $(function() {

        var device_name;
        while( !(device_name = prompt('請輸入裝置名稱', 'My-Phone')) )
            ;
        var interval = 250;
        var accur = 10;

        var acc  = {};
        var gyro = {};
        var orient = {};
        var AxDom = $('#Ax > span');
        var AyDom = $('#Ay > span');
        var AzDom = $('#Az > span');


        window.ondevicemotion = function(event) {
            var ax = event.accelerationIncludingGravity.x || 0;
            var ay = event.accelerationIncludingGravity.y || 0;
            var az = event.accelerationIncludingGravity.z || 0;

            acc.x = Math.round(ax*accur) / accur;
            acc.y = Math.round(ay*accur) / accur;
            acc.z = Math.round(az*accur) / accur;

            AxDom.text(acc.x);
            AyDom.text(acc.y);
            AzDom.text(acc.z);

            dan2.push('Acceleration', [acc.x, acc.y, acc.z]);
        }


        // Register
        function on_signal(cmd, param) {
            console.info('[cmd]', cmd, param);
            return true;
        }

        function on_data(idf_name, data) {
            console.info('[data]', idf_name, data);
        }

        function init_callback(result) {
            console.info('register:', result);
            $('#uuid').text(result ? 'Connected' : 'GG');
        }

        dan2.register('https://example.com/csm', {
            'name': device_name,
            'on_signal': on_signal,
            'on_data': on_data,
            'idf_list': [
                ['Acceleration', ['g', 'g', 'g']],
            ],
            'profile': {
                'model': 'Smartphone',
            },
            'accept_protos': ['mqtt'],
        }, init_callback);

    });

    </script>

</body>
</html>
